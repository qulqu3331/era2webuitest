こちら1年以上前に書いた資料なので最新バージョンの実装と合わない情報が散見されます。



# カスタマイズ資料　兼チラシの裏
複数バリアントに対応するしくみに手を付けていないため、データ仕様は今後変わると思う

- pyファイルの構成

| ファイル名 | 概要 |
| ---- | ---- |
| era2webui.py | 実行用のファイル。savフォルダを監視し、txtの更新を検知してあれこれ呼び出す。|
| sub.py | バリアントによらない共通の関数を記述。ブラウザ操作はここ。|
| suberaXXXX.py | XXXXにバリアントを表す記号が入る。バリアントにより違いの出る関数を記述。プロンプト生成はここ。|
| emo.py | プロンプト生成処理のうち、感情表現だけ切り出したもの。なんとなく。|
| imageviewer.py | 画像表示用のウィンドウを表示する機能。pngファイルの新規作成を監視する。|


- emuera側の動作
   - TEXTLOG.ERB に記述した**OUTPUT_TXT**関数がほぼ全ての処理を行う。他のERB改変は **CALL OUTPUT_TXT("シーン名称")**  をあちこちに記述しているだけ。
   - **OUTPUT_TXT**関数はキャラクター情報や選択したコマンド等をjson文字列にまとめ、txtファイルとしてsavフォルダに出力する。
   - 200ミリ秒未満の連続呼び出しは無視する。
   - txtファイルは0～4までの連番つきで出力される。5回出力するまで上書きしないことで読み取りの猶予時間を作っている。

- ブラウザ操作
   - 今のところはプロンプト、ネガティブ、 縦横の解像度だけを弄っている。解像度変更の指定がない場合は前回生成の設定で生成する。
   - プロンプト欄に記述して機能する拡張（例えばDynamicPromptsやLoraBrockWeightなど）は問題なく動く。

## csv編集について
csvは画像生成の度に読み込む。編集して上書き保存すると即時反映される

- とりあえず
   - 最初にEffect.csvを開いて基礎プロンプトと人物プロンプトをいつも使っているやつに書き換えるとよい  (旧版ではEvent.csvに入ってた)

## Train.csv
コマンドに対応するプロンプトを記述するファイル  
Eraが吐き出した**コマンド番号**に対応したプロンプトが読み込まれる。コマンド名は飾り。

| 列ラベル | 概要 |
| ---- | ---- |
| プロンプト| 記入した文字列をプロンプトに渡す<br>**空欄にすると特殊処理**として、汎用調教プロンプト(Event.csvに記述)を呼び出す|
| ネガティブ| 記入した文字列をネガティブプロンプトに渡す|
| 解像度| 「512x768」などと記入すると出力時に解像度を変更する。（解像度自動変更機能をONにしている場合。）<BR>初期設定では%縦長%などと置換機能を利用した書き方をしている。詳細は後述。|
| 拒否プロンプト| 実行に成否判定のあるコマンドに失敗したときに読み出される。初期設定では置換機能を利用している。<br> **成否判定のないコマンドでは空欄にしておかないと誤動作する。**|
| 拒否ネガティブ| 略|
| キャラ描画 | プロンプトにキャラクターの記述を含めるかどうかのフラグ。1か0を入れる。|
| 顔描画 | プロンプトに表情の記述を含めるかどうかのフラグ。1か0を入れる。|
| 胸描画 | プロンプトに胸サイズなどの記述を含めるかどうかのフラグ。1か0を入れる。<br>1にするとlerge breasts等が追加され**胸が映るはずのない構図に無理やり胸をねじ込まれる**ことがあるので注意。以下同様|
| ヴァギナ描画 | プロンプトに**バイブや愛液等**の記述を含めるかどうかのフラグ。1か0を入れる。<br>**1にしなくても局部自体の描画はされる。** あくまでも付帯物の描画をオンにするために使う|
| アナル描画 | プロンプトに**アナルバイブ等**の記述を含めるかどうかのフラグ。1か0を入れる。|
   
- 特殊処理
   - YMの仕様で 正常位>正常位 や 後背位>後背位 のように実行すると614:挿入Gスポ責めか615:挿入子宮口責めのどちらかに派生するが、絵作り的には前からか後ろからかをコントロールできないと困るので、対面からの派生は614番、背面からの派生は615番のプロンプトを参照する。
   - 巨乳素質を持たないキャラの42:パイズリは56:ナイズリのプロンプトに変換する。
   
## ReplaceList.csv (置換機能)
置換前と置換後の文字列を書くファイル。  
**%で囲まれた文字列**をReplaceList.csvに基づいて置換する。  
プロンプト・ネガティブ文字列および解像度欄で置換機能が有効。  
例：%縦長%という文字列を512x640という文字列に置換する。  

- 細かい話  
置換処理はプロンプト生成処理が終わってブラウザに渡す直前に行う。一度にいくつでも置換できるが、一度置換したものを再び置換はしない。  
プロンプト中に%で囲まれた文字列が存在し、ReplaceList.csvに該当の文字列がない場合、Errorという文字列に置換される。  
 (余計なことをせずに何も置換しないほうがいいだろうからあとで直す)  
プロンプトに%なんて誰も使わんやろーと思っているが問題がありそうなら他の記号にします。  
既知の不具合:プロンプトの最初に Ichigo100%、最後の方にToguro100% があったりすると、ごっそり消失してIchigo100Errorだけが残る。あとで直さねば


## Charactor.csv
キャラクターの容姿のプロンプトを記述するファイル。  
キャラ描画フラグが1の場面で読み出される。  
Eraが吐き出した**CALLNAME**が**キャラ名列**に一致する行のプロンプトが読み込まれる。キャラ番号はいまのところは飾り。  
CALLNAMEって口上で変化しそう。問題になるようなら修正する。
| 列ラベル | 概要 |
| ---- | ---- |
|プロンプト、<br>ネガティブ|略|
| 目の色 | red,yellowなど色名だけを書くと、プロンプトにはred eyesのように反映される。<br>学習が十分なキャラでは空欄にすることを推奨。色名は服や髪等への色写りのリスクがあるのでなるべく記述したくない。髪色の間違いは大問題だが目の色は間違ってもそれほど困らない（個人の感想）。違和感が強い間違いが多発するときには記述する|

## Add_charactor.csv
カスタマイズキャラクターを追加するために用意したファイル。  
Charactor.csvと内部的に結合して読み込まれる。Charactor.csvに書き込むのと同じ結果になるので別になくてもいいファイル。
- キャラクター強制変更機能
  - 拾ってきたキャラクターLoraを試用したりするのに使う機能
  - キャラ名欄に「描画キャラ上書き」と書かれた行にプロンプトを記入すると、本来のキャラクタープロンプトに置き買わる。

## Event.csv
Train以外のシーン描写を記述するファイル。  
Train同様に、プロンプトのほか解像度や描画フラグ等を設定する。 

- ***新しい画像表示シーン追加の仕方***
1. ***ERB中にCALL OUTPUT_TXT("シーン名称")を記述する。***
2. ***Event.csvの名称列に同じシーン名称を書き、プロンプトを記述すれば完了。***

| 列ラベル | 概要 |
| ---- | ---- |
|名称|CALL OUTPUT_TXT()の引数で指定した文字列に一致するとプロンプトを読み出す|
|プロンプトほか|Trainと同じ|
|主人以外が相手|主人公以外を相手に何かしらするときのフラグ。1を入れると、恋慕や反発刻印の表情への影響が出なくなる。ちなみに調教中に助手と交代しているときも同じ処理をしている。|

Event.csvにはいくつか特殊なシーンが記述されている。
- 汎用調教
   - Train.csvのプロンプト列が空欄のコマンドを実行したとき、ここを読みに来る
   
## Effect.csv
各種エフェクトのプロンプトを記入するファイル。射精エフェクトなど。  
Event.csvと違って解像度や描画フラグを含まない。  
**いまのところ、絶頂などほとんどのエフェクトはプログラム中に直書きしております。**
条件分岐と一緒に書いちゃった方が可読性がいいので悩みどころ。

- ***基礎プロンプト***
  - すべての生成に無条件で付加するプロンプトとネガティブを記述する。
- ***人物プロンプト***
  - キャラ描画ありのときのすべての生成に付加するプロンプトとネガティブを記述する。

## Equip.csv
装備品のプロンプトを記入するファイル。TEQUIPフラグと値の2次元のキーをもつ。  
eraからtxt出力するとき、値が0でないTEQUIPフラグはすべて書き出している。  
書き出したTEQUIPと値でcsvを捜査して一致する行のプロンプトを読み出す。  
しばしば未定義の装備を捜査してエラーを吐いてる。  
バイブ・アナルバイブは各描画フラグがONのときしか描写しない。 
（よいプロンプトが見つからないため、今配布してるverではバイブ・アナルバイブのプロンプトは空欄。）

## Location.csv
場所に対応するプロンプトを書くファイル。  
場所移動のあるバリアントに対応したら場所IDとプロンプトの対応を書くファイルになると思う。  
YMの場合はほぼ野外プレイ専用で、pyコード中で場所判別して呼び出している。
  
## 解像度指定の記法について
"x"(小文字のエックス)で分割された2つの整数を書くと横×縦の解像度として認識する。認識できない場合は解像度変更をスキップする。 
"X","*","×"でも認識するようにした。  
解像度欄に限定の特殊処理として、カンマで区切った複数の解像度を入力するとランダム選択として解釈する。例:「512x512,512x640,512x768」で3択。  
前述のとおり解像度欄は%による置換機能に対応している。
処理の順序は「%による置換」>「カンマによるランダム選択」>「xによる分割」の順
「%正方形%,%縦長%,512x768」のような指定ができる。  

## やりたいこととか妄想
- プロンプトつけかえ用の、いつでも呼び出せる装備的なもの
- 表情コントロールの作り直し
- 口上に先んじた画像表示（上昇パラメータの先取り）
- Add_charactor.csvにガーッと書いたキャラをウワーッと店頭に並べるプログラム
- 脱衣のコントロール
- csvでプロンプトの分岐を増やす書き方を考える。陥落や慣れで構図から変えられるように
- 表示した画像上にポップアップ画像を重ねる。あらかじめ用意した書き文字とかカットイン的なの
- ひな形画像をControlNetに渡す
